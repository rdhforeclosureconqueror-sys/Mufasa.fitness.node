<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mufasa Live Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- TensorFlow + Pose Detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection"></script>
  <!-- MediaPipe backend for BlazePose -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 12px;
    }
    .app {
      width: 100%;
      max-width: 1200px;
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 0.9fr);
      gap: 16px;
    }
    @media (max-width: 900px) {
      .app { grid-template-columns: 1fr; }
    }
    .panel {
      background: #020617;
      border-radius: 14px;
      border: 1px solid #1e293b;
      padding: 14px;
      box-shadow: 0 14px 40px rgba(15,23,42,0.8);
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 1rem;
      margin-bottom: 6px;
      color: #a5b4fc;
    }
    #videoContainer {
      position: relative;
      width: 100%;
      background: #020617;
      border-radius: 12px;
      overflow: hidden;
      aspect-ratio: 4 / 3;
      border: 1px solid #1e293b;
    }
    video, canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .controls {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      border: none;
      padding: 8px 12px;
      border-radius: 999px;
      background: #22c55e;
      color: #022c22;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.9rem;
    }
    button.secondary {
      background: #0f172a;
      color: #e5e7eb;
      border: 1px solid #1f2937;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      background: #020617;
      color: #e5e7eb;
      padding: 8px;
      resize: vertical;
    }
    .chat-log {
      margin-top: 10px;
      border-radius: 10px;
      border: 1px solid #1e293b;
      padding: 8px;
      height: 260px;
      overflow-y: auto;
      background: #020617;
    }
    .msg {
      margin-bottom: 8px;
      line-height: 1.35;
      font-size: 0.9rem;
    }
    .msg.you { color: #38bdf8; }
    .msg.mufasa { color: #bbf7d0; }
    .status {
      font-size: 0.8rem;
      color: #9ca3af;
      margin-top: 6px;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #0f172a;
      border: 1px solid #1f2937;
      font-size: 0.75rem;
      color: #a5b4fc;
    }
    .dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: Camera + Pose -->
    <div class="panel">
      <h1>Mufasa Live Coach</h1>
      <div class="badge">
        <span class="dot"></span>
        <span>Brain: <span id="brainStatus">checkingâ€¦</span></span>
      </div>

      <div id="videoContainer" style="margin-top:10px;">
        <video id="video" playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="controls">
        <button id="startBtn">Start workout</button>
        <button id="stopBtn" class="secondary" disabled>Stop workout</button>
      </div>

      <div class="status" id="poseStatus">
        Pose detector: not started.
      </div>
    </div>

    <!-- RIGHT: Chat with Mufasa -->
    <div class="panel">
      <h2>Ask Coach Mufasa</h2>
      <textarea id="question" placeholder="Ask for a workout, feedback, or life strategyâ€¦"></textarea>
      <div class="controls" style="margin-top:6px;">
        <button id="askBtn">Ask coach</button>
        <button id="muteBtn" class="secondary">ðŸ”Š Voice: ON</button>
      </div>
      <div class="status" id="chatStatus">Waiting for your question.</div>
      <div class="chat-log" id="chatLog"></div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const BRAIN_URL = "https://mufasabrain.onrender.com";  // Python brain
    const ASK_URL   = BRAIN_URL + "/ask";

    // === VOICE (browser TTS) ===
    let voiceEnabled = true;
    function speak(text) {
      if (!voiceEnabled || !("speechSynthesis" in window)) return;
      const utt = new SpeechSynthesisUtterance(text);
      utt.rate = 1.0;
      utt.pitch = 1.0;
      utt.lang = "en-US";
      window.speechSynthesis.speak(utt);
    }

    // === CHAT UI ===
    const questionEl  = document.getElementById("question");
    const askBtn      = document.getElementById("askBtn");
    const chatLog     = document.getElementById("chatLog");
    const chatStatus  = document.getElementById("chatStatus");
    const brainStatus = document.getElementById("brainStatus");
    const muteBtn     = document.getElementById("muteBtn");

    function addMsg(role, text) {
      const div = document.createElement("div");
      div.className = "msg " + role;
      div.textContent = (role === "you" ? "You: " : "Mufasa: ") + text;
      chatLog.appendChild(div);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    muteBtn.onclick = () => {
      voiceEnabled = !voiceEnabled;
      muteBtn.textContent = voiceEnabled ? "ðŸ”Š Voice: ON" : "ðŸ”ˆ Voice: OFF";
    };

    askBtn.onclick = async () => {
      const q = questionEl.value.trim();
      if (!q) return;
      askBtn.disabled = true;
      chatStatus.textContent = "Asking Mufasaâ€¦";
      addMsg("you", q);

      try {
        const res = await fetch(ASK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: q })
        });

        if (!res.ok) {
          const txt = await res.text();
          addMsg("mufasa", "Error from brain: " + txt);
          chatStatus.textContent = "Error from brain.";
        } else {
          const data = await res.json();
          const answer = data.answer || "(no answer field)";
          addMsg("mufasa", answer);
          chatStatus.textContent = "Coach ready.";
          speak(answer);
        }
      } catch (err) {
        console.error(err);
        addMsg("mufasa", "Network error talking to brain.");
        chatStatus.textContent = "Network error.";
      } finally {
        askBtn.disabled = false;
      }
    };

    // Check brain health on load
    (async () => {
      try {
        const res = await fetch(BRAIN_URL + "/health");
        if (!res.ok) throw new Error("bad status");
        const data = await res.json();
        brainStatus.textContent = `online (phase ${data.phase})`;
      } catch (e) {
        brainStatus.textContent = "offline";
      }
    })();

    // === TENSORFLOW POSE DETECTION ===
    const video = document.getElementById("video");
    const canvas = document.getElementById("overlay");
    const ctx = canvas.getContext("2d");
    const startBtn = document.getElementById("startBtn");
    const stopBtn  = document.getElementById("stopBtn");
    const poseStatus = document.getElementById("poseStatus");

    let detector = null;
    let running = false;

    async function initDetector() {
      try {
        poseStatus.textContent = "Loading pose modelâ€¦";
        const model = posedetection.SupportedModels.BlazePose;
        const detectorConfig = {
          runtime: "tfjs",
          modelType: "full",  // more accurate
        };
        detector = await posedetection.createDetector(model, detectorConfig);
        poseStatus.textContent = "Pose model ready.";
      } catch (err) {
        console.error(err);
        poseStatus.textContent = "Error loading pose model.";
      }
    }

    async function setupCamera() {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: false,
        video: { facingMode: "user" }
      });
      video.srcObject = stream;
      await video.play();

      // Match canvas size
      canvas.width = video.videoWidth || 640;
      canvas.height = video.videoHeight || 480;
    }

    async function poseLoop() {
      if (!running || !detector) return;

      const poses = await detector.estimatePoses(video);
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      if (poses && poses.length > 0) {
        const kp = poses[0].keypoints;
        ctx.lineWidth = 4;
        ctx.strokeStyle = "#22c55e";
        ctx.fillStyle = "#22c55e";

        for (const p of kp) {
          if (!p.score || p.score < 0.4) continue;
          const x = (p.x / video.videoWidth) * canvas.width;
          const y = (p.y / video.videoHeight) * canvas.height;
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fill();
        }
      }

      requestAnimationFrame(poseLoop);
    }

    startBtn.onclick = async () => {
      try {
        startBtn.disabled = true;
        stopBtn.disabled  = false;
        poseStatus.textContent = "Starting cameraâ€¦";

        if (!detector) {
          await initDetector();
        }
        await setupCamera();
        running = true;
        poseStatus.textContent = "Workout begins in 3â€¦ 2â€¦ 1â€¦";
        speak("Workout begins in three, two, one. Stand back so I can see your whole body.");
        requestAnimationFrame(poseLoop);
      } catch (err) {
        console.error(err);
        poseStatus.textContent = "Error starting workout.";
        startBtn.disabled = false;
        stopBtn.disabled  = true;
      }
    };

    stopBtn.onclick = () => {
      running = false;
      const stream = video.srcObject;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
      }
      video.srcObject = null;
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      poseStatus.textContent = "Workout stopped.";
      startBtn.disabled = false;
      stopBtn.disabled  = true;
    };
  </script>
</body>
</html>
