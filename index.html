<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mufasa Live Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- ‚úÖ TensorFlow + Pose Detection (UMD) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.14.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@0.0.6/dist/pose-detection.min.js"></script>

  <!-- Tiny data URI favicon to kill 404 -->
  <link rel="icon" href="data:,">

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: radial-gradient(circle at top left, #0f172a, #020617);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9);
      padding: 20px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 20px;
    }

    @media (max-width: 800px) { .app { grid-template-columns: 1fr; } }

    h1 { font-size: 1.6rem; margin-bottom: 4px; }
    .subtitle { font-size: 0.9rem; color: #9ca3af; margin-bottom: 16px; }

    .pane {
      background: rgba(15, 23, 42, 0.8);
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid rgba(30, 64, 175, 0.6);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .video-shell {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 12px;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(51, 65, 85, 0.8);
    }

    video, canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #1d4ed8;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.08s ease;
    }

    button.secondary {
      background: #0f172a;
      border: 1px solid #1e293b;
      color: #e5e7eb;
    }

    button:disabled { opacity: 0.5; cursor: default; }
    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #2563eb;
    }

    .status-line { font-size: 0.8rem; color: #9ca3af; }
    .status-ok { color: #4ade80; }
    .status-bad { color: #f87171; }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #9ca3af;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34,197,94,0.9);
    }

    input[type="text"] {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      font-size: 0.9rem;
      outline: none;
    }

    input[type="text"]::placeholder { color: #6b7280; }

    #coach-log {
      flex: 1;
      min-height: 140px;
      max-height: 260px;
      overflow-y: auto;
      background: #020617;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 0.85rem;
    }

    .log-line { margin-bottom: 4px; }
    .log-line.you { color: #e5e7eb; }
    .log-line.coach { color: #a5b4fc; }
    .log-line.system { color: #6b7280; font-style: italic; }

    .mini-metrics {
      display: flex;
      gap: 10px;
      font-size: 0.8rem;
      color: #9ca3af;
    }
    .mini-metrics span strong { color: #e5e7eb; }
  </style>
</head>

<body>
  <div class="app">
    <div class="pane">
      <h1>Mufasa Live Coach</h1>
      <p class="subtitle">Webcam + TensorFlow MoveNet + Voice + Ma‚Äôat Brain</p>

      <div class="video-shell">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="btn-row">
        <button id="connectBtn">Connect Camera</button>
        <button id="startBtn" class="secondary" disabled>Start Workout</button>
        <button id="listenBtn" class="secondary">üéôÔ∏è Voice On</button>
        <button id="muteBtn" class="secondary">üîä Mute</button>
        <span class="chip">
          <span class="chip-dot"></span>
          <span id="brainChipText">Brain: connecting‚Ä¶</span>
        </span>
      </div>

      <div class="status-line">
        <strong>Pose:</strong> <span id="poseStatus">Not started.</span>
      </div>
      <div class="status-line">
        <strong>Brain:</strong> <span id="brainStatus">Not contacted yet.</span>
      </div>

      <div class="mini-metrics">
        <span><strong>Exercise:</strong> <span id="metricExercise">None</span></span>
        <span><strong>Set:</strong> <span id="metricSet">0</span></span>
        <span><strong>Rep:</strong> <span id="metricRep">0</span></span>
      </div>
    </div>

    <div class="pane">
      <h2 style="font-size:1.1rem;">Coach Chat</h2>
      <p class="subtitle">Ask Mufasa or speak‚Äîyour coach listens now.</p>
      <div style="display:flex; gap:8px;">
        <input id="questionInput" type="text" placeholder="Ask or speak to your coach..." />
        <button id="askBtn">Ask</button>
      </div>
      <div id="coach-log"></div>
    </div>
  </div>

  <script>
    console.log("üî• Mufasa Coach script initialized");

    // === CONFIG ===
    const BRAIN_BASE_URL = "https://mufasabrain.onrender.com";
    const ASK_URL = BRAIN_BASE_URL + "/ask";
    const USER_ID = "rashad";

    // Simple workout program model
    const PROGRAM = {
      name: "Lower Body Starter",
      exercises: [
        { id: "bodyweight_squat", name: "Bodyweight Squat", sets: 3, reps: 10 }
      ]
    };

    // === DOM REFERENCES ===
    const videoEl = document.getElementById("video");
    const canvasEl = document.getElementById("overlay");
    const ctx = canvasEl.getContext("2d");
    const poseStatusEl = document.getElementById("poseStatus");
    const brainStatusEl = document.getElementById("brainStatus");
    const brainChipTxt = document.getElementById("brainChipText");
    const connectBtn = document.getElementById("connectBtn");
    const startBtn = document.getElementById("startBtn");
    const muteBtn = document.getElementById("muteBtn");
    const askBtn = document.getElementById("askBtn");
    const questionInput = document.getElementById("questionInput");
    const listenBtn = document.getElementById("listenBtn");
    const logEl = document.getElementById("coach-log");

    const metricExerciseEl = document.getElementById("metricExercise");
    const metricSetEl = document.getElementById("metricSet");
    const metricRepEl = document.getElementById("metricRep");

    // === STATE ===
    let detector;
    let running = false;
    let animId;
    let voiceMuted = false;
    let listening = false;
    let recognition;

    let lastPoseVisible = false;
    let sessionId = null;
    let currentExerciseIndex = 0;
    let currentSet = 1;
    let repCount = 0;
    let inSquat = false;
    let lastCoachCueAt = 0; // ms timestamp, to throttle /ask

    function currentExercise() {
      return PROGRAM.exercises[currentExerciseIndex];
    }

    // === UI HELPERS ===
    function addLog(kind, text) {
      const div = document.createElement("div");
      div.className = "log-line " + kind;
      div.textContent = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function speak(text) {
      if (voiceMuted || !("speechSynthesis" in window)) return;
      const u = new SpeechSynthesisUtterance(text);
      u.rate = 1.0;
      u.pitch = 1.0;
      window.speechSynthesis.speak(u);
    }

    function updateMetricsDisplay() {
      const ex = currentExercise();
      metricExerciseEl.textContent = ex ? ex.name : "None";
      metricSetEl.textContent = running ? String(currentSet) : "0";
      metricRepEl.textContent = running ? String(repCount) : "0";
    }

    // === BRAIN HEALTH CHECK ===
    (async () => {
      try {
        const res = await fetch(BRAIN_BASE_URL + "/health");
        const data = await res.json();
        brainStatusEl.textContent = `Phase ${data.phase}, model ${data.openai_model}`;
        brainChipTxt.textContent = `Brain: phase ${data.phase} ¬∑ ${data.openai_model}`;
      } catch {
        brainStatusEl.textContent = "Brain offline.";
        brainChipTxt.textContent = "Brain: offline";
      }
    })();

    // === CAMERA + POSE ===
    async function connectCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        videoEl.srcObject = stream;
        await new Promise(r => videoEl.onloadedmetadata = r);
        canvasEl.width = videoEl.videoWidth;
        canvasEl.height = videoEl.videoHeight;
        poseStatusEl.textContent = "Camera connected. Loading pose detector‚Ä¶";
        await initDetector();
        poseStatusEl.textContent = "Pose detector ready.";
        poseStatusEl.classList.add("status-ok");
        startBtn.disabled = false;
      } catch (e) {
        console.error(e);
        poseStatusEl.textContent = "Camera error.";
        poseStatusEl.classList.add("status-bad");
      }
    }

    async function initDetector() {
      await tf.setBackend("webgl");
      await tf.ready();
      if (typeof poseDetection === "undefined") {
        console.error("PoseDetection failed to load. Check script URL.");
        return;
      }
      detector = await poseDetection.createDetector(
        poseDetection.SupportedModels.MoveNet,
        {
          modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
        }
      );
      console.log("‚úÖ MoveNet detector created.");
    }

    // === BASIC AI CHAT ===
    async function askCoach(q, extraContext) {
      if (!q) return;
      const userText = extraContext ? `${q}\n\n${extraContext}` : q;
      addLog("you", "You: " + q);
      questionInput.value = "";
      brainStatusEl.textContent = "Thinking‚Ä¶";
      try {
        const res = await fetch(ASK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            question: userText,
            user_id: USER_ID,
            session_id: sessionId,
            domain: "fitness"
          })
        });
        const data = await res.json();
        const answer = data.answer || "No response.";
        addLog("coach", "Mufasa: " + answer);
        speak(answer);
        brainStatusEl.textContent = "Coach responded.";
      } catch (err) {
        console.error(err);
        brainStatusEl.textContent = "Brain error.";
        addLog("system", "Network error contacting brain.");
      }
    }

    // === REP DETECTION + WORKOUT LOOP ===
    function estimateSquatDepth(pose) {
      // Very simple: use average hip Y vs average knee Y.
      if (!pose || !pose.keypoints) return null;
      const kp = pose.keypoints;

      // MoveNet index names (0..16), using left/right hip/knee
      const leftHip   = kp[11];
      const rightHip  = kp[12];
      const leftKnee  = kp[13];
      const rightKnee = kp[14];

      if (!leftHip || !rightHip || !leftKnee || !rightKnee) return null;
      if (leftHip.score < 0.3 || rightHip.score < 0.3 ||
          leftKnee.score < 0.3 || rightKnee.score < 0.3) return null;

      const hipY  = (leftHip.y + rightHip.y) / 2;
      const kneeY = (leftKnee.y + rightKnee.y) / 2;

      // Depth = how far hips have dropped below knees.
      return hipY - kneeY; // positive = hips lower (deeper squat)
    }

    async function runPoseLoop() {
      if (!running || !detector) return;

      const poses = await detector.estimatePoses(videoEl, { flipHorizontal: true });
      ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);

      let visible = false;
      let primaryPose = null;

      if (poses.length) {
        visible = true;
        primaryPose = poses[0];
        for (const kp of primaryPose.keypoints) {
          if (kp.score > 0.4) {
            ctx.beginPath();
            ctx.arc(kp.x, kp.y, 4, 0, Math.PI * 2);
            ctx.fillStyle = "#22c55e";
            ctx.fill();
          }
        }
      }

      poseStatusEl.textContent = visible ? "Pose detected." : "No pose.";

      if (visible !== lastPoseVisible) {
        lastPoseVisible = visible;
        speak(visible ? "Good, I can see you." : "Step back a bit.");
      }

      // === Simple squat rep detection ===
      if (visible && primaryPose) {
        const depth = estimateSquatDepth(primaryPose);
        if (depth !== null) {
          const threshold = 20; // tune this based on camera distance
          // Going DOWN into a squat
          if (depth > threshold && !inSquat) {
            inSquat = true;
          }
          // Coming UP out of squat -> count rep
          if (depth < threshold * 0.5 && inSquat) {
            inSquat = false;
            repCount += 1;
            metricRepEl.textContent = String(repCount);
            console.log("Rep counted:", repCount);

            // If we hit target reps for this set
            const ex = currentExercise();
            if (ex && repCount >= ex.reps) {
              await handleSetCompleted();
            } else {
              // Optional small local cue
              speak("Good rep, keep going.");
            }
          }
        }
      }

      animId = requestAnimationFrame(runPoseLoop);
    }

    async function handleSetCompleted() {
      const ex = currentExercise();
      addLog("system", `Set ${currentSet} completed for ${ex.name}.`);
      speak(`Set ${currentSet} complete. Nice work.`);

      // Call AI for a quick coaching cue after the set (throttled)
      const now = Date.now();
      if (now - lastCoachCueAt > 8000) { // 8 seconds minimum between cues
        lastCoachCueAt = now;
        const ctxMsg =
          `We just finished set ${currentSet} of ${ex.sets} for ${ex.name}. ` +
          `Target reps per set: ${ex.reps}. The user completed at least ${repCount} reps. ` +
          `Give one short coaching cue and suggest how they should breathe or focus before the next set.`;
        await askCoach("Give a coaching cue after that set.", ctxMsg);
      }

      // Move to next set or finish exercise
      const exSets = ex.sets || 1;
      if (currentSet < exSets) {
        currentSet += 1;
        repCount = 0;
        metricSetEl.textContent = String(currentSet);
        metricRepEl.textContent = "0";
        speak(`Get ready for set ${currentSet}.`);
      } else {
        // Finished all sets of this exercise for now
        speak(`You finished all sets for ${ex.name}. Great job.`);
        addLog("system", `All sets completed for ${ex.name}.`);
        // For now, end workout automatically
        await stopWorkoutInternal();
      }
    }

    async function stopWorkoutInternal() {
      running = false;
      startBtn.textContent = "Start Workout";
      cancelAnimationFrame(animId);
      ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
      poseStatusEl.textContent = "Workout stopped.";
      addLog("system", "Workout stopped.");

      // Reset state for next session
      inSquat = false;
      repCount = 0;
      currentSet = 1;
      sessionId = null;
      updateMetricsDisplay();
    }

    async function startWorkout() {
      if (!detector) return;
      running = !running;

      if (running) {
        sessionId = "sess_" + Date.now();
        const ex = currentExercise();

        startBtn.textContent = "Stop Workout";
        currentSet = 1;
        repCount = 0;
        inSquat = false;
        updateMetricsDisplay();

        speak("Workout begins in three, two, one.");
        addLog("system", `Workout started: ${sessionId} ¬∑ Program: ${PROGRAM.name}`);

        // Ask AI to introduce the workout with context
        const introCtx =
          `We are starting a workout program called "${PROGRAM.name}". ` +
          `First exercise is ${ex.name}, with ${ex.sets} sets of ${ex.reps} reps. ` +
          `Speak as a supportive coach, give a short intro and remind the user about form.`;
        await askCoach("Introduce this workout for the user.", introCtx);

        runPoseLoop();
      } else {
        await stopWorkoutInternal();
      }
    }

    // === STT (Speech Recognition) ===
    function toggleListening() {
      const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
      if (!SR) return alert("Speech recognition not supported.");
      if (!recognition) {
        recognition = new SR();
        recognition.lang = "en-US";
        recognition.interimResults = false;
        recognition.onresult = e => {
          const transcript = e.results[0][0].transcript;
          addLog("you", "üéôÔ∏è " + transcript);
          askCoach(transcript);
        };
        recognition.onerror = e => addLog("system", "STT error: " + e.error);
        recognition.onend = () => {
          listening = false;
          listenBtn.textContent = "üéôÔ∏è Voice On";
        };
      }
      if (!listening) {
        recognition.start();
        listening = true;
        listenBtn.textContent = "üéß Listening‚Ä¶";
        addLog("system", "Listening for your voice...");
      } else {
        recognition.stop();
        listening = false;
        listenBtn.textContent = "üéôÔ∏è Voice On";
      }
    }

    // === BUTTON WIRING ===
    connectBtn.onclick = connectCamera;
    startBtn.onclick = () => { startWorkout(); };
    askBtn.onclick = () => askCoach(questionInput.value.trim());
    muteBtn.onclick = () => {
      voiceMuted = !voiceMuted;
      muteBtn.textContent = voiceMuted ? "üîá Unmute" : "üîä Mute";
    };
    listenBtn.onclick = toggleListening;
    questionInput.addEventListener("keydown", e => {
      if (e.key === "Enter") askCoach(questionInput.value.trim());
    });

    // === ON LOAD ===
    window.addEventListener("load", () => {
      addLog("system", "Page loaded. Connect your camera to begin.");
      const ex = currentExercise();
      metricExerciseEl.textContent = ex ? ex.name : "None";
      metricSetEl.textContent = "0";
      metricRepEl.textContent = "0";
      console.log("tf loaded:", typeof tf !== "undefined");
      console.log("poseDetection loaded:", typeof poseDetection !== "undefined");
    });
  </script>
</body>
</html>
