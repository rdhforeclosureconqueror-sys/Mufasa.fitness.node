<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mufasa Live Coach</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- TensorFlow + Pose Detection (global: tf, poseDetection) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.20.0/dist/tf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.20.0/dist/tf-converter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.20.0/dist/tf-backend-webgl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@3.3.0/dist/pose-detection.min.js"></script>

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1100px;
      background: radial-gradient(circle at top left, #0f172a, #020617);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 24px 80px rgba(15, 23, 42, 0.9);
      padding: 20px;
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 20px;
    }

    @media (max-width: 800px) {
      .app {
        grid-template-columns: 1fr;
      }
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 4px;
    }

    .subtitle {
      font-size: 0.9rem;
      color: #9ca3af;
      margin-bottom: 16px;
    }

    .pane {
      background: rgba(15, 23, 42, 0.8);
      border-radius: 12px;
      padding: 12px 14px;
      border: 1px solid rgba(30, 64, 175, 0.6);
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .video-shell {
      position: relative;
      width: 100%;
      aspect-ratio: 4 / 3;
      border-radius: 12px;
      overflow: hidden;
      background: #020617;
      border: 1px solid rgba(51, 65, 85, 0.8);
    }

    video, canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .btn-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #1d4ed8;
      color: white;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, transform 0.08s ease;
    }

    button.secondary {
      background: #0f172a;
      border: 1px solid #1e293b;
      color: #e5e7eb;
    }

    button:disabled {
      opacity: 0.5;
      cursor: default;
    }

    button:hover:not(:disabled) {
      transform: translateY(-1px);
      background: #2563eb;
    }

    .status-line {
      font-size: 0.8rem;
      color: #9ca3af;
    }

    .status-line strong {
      color: #e5e7eb;
    }

    .status-ok {
      color: #4ade80;
    }

    .status-warn {
      color: #f97316;
    }

    .status-bad {
      color: #f97373;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(55, 65, 81, 0.9);
      color: #9ca3af;
    }

    .chip-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 10px rgba(34, 197, 94, 0.9);
    }

    .chat-input-row {
      display: flex;
      gap: 8px;
      margin-top: 6px;
    }

    input[type="text"] {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background: #020617;
      color: #e5e7eb;
      padding: 8px 12px;
      font-size: 0.9rem;
      outline: none;
    }

    input[type="text"]::placeholder {
      color: #6b7280;
    }

    #coach-log {
      flex: 1;
      min-height: 140px;
      max-height: 260px;
      overflow-y: auto;
      background: #020617;
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid rgba(31, 41, 55, 0.9);
      font-size: 0.85rem;
    }

    .log-line {
      margin-bottom: 4px;
    }

    .log-line.you {
      color: #e5e7eb;
    }
    .log-line.coach {
      color: #a5b4fc;
    }
    .log-line.system {
      color: #6b7280;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- LEFT: Video + Pose -->
    <div class="pane">
      <div>
        <h1>Mufasa Live Coach</h1>
        <p class="subtitle">
          Webcam + TensorFlow pose detection + Node brain + Ma’at brain behind the scenes.
        </p>
      </div>

      <div class="video-shell">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="btn-row">
        <button id="connectBtn">Connect Camera</button>
        <button id="startBtn" class="secondary" disabled>Start Workout</button>
        <button id="muteBtn" class="secondary">Mute voice</button>
        <span class="chip" id="brainChip">
          <span class="chip-dot"></span>
          <span id="brainChipText">Brain: connecting…</span>
        </span>
      </div>

      <div class="status-line">
        <strong>Pose:</strong>
        <span id="poseStatus">Not started.</span>
      </div>
      <div class="status-line">
        <strong>Brain:</strong>
        <span id="brainStatus">Not contacted yet.</span>
      </div>
    </div>

    <!-- RIGHT: Chat -->
    <div class="pane">
      <div>
        <h2 style="font-size:1.1rem; margin-bottom:4px;">Coach Chat</h2>
        <p class="subtitle">
          Ask Mufasa anything about today’s workout, recovery, or mindset.
        </p>
      </div>

      <div class="chat-input-row">
        <input id="questionInput" type="text"
               placeholder='Ask the coach a question… e.g. "Give me a 3-exercise leg workout with no equipment."' />
        <button id="askBtn">Ask</button>
      </div>

      <div id="coach-log"></div>
    </div>
  </div>

  <script>
    // === CONFIG =============================================================
    const BRAIN_BASE_URL = "https://mufasabrain.onrender.com";
    const ASK_URL = BRAIN_BASE_URL + "/ask";

    // === DOM ELEMENTS =======================================================
    const videoEl      = document.getElementById("video");
    const canvasEl     = document.getElementById("overlay");
    const poseStatusEl = document.getElementById("poseStatus");
    const brainStatusEl= document.getElementById("brainStatus");
    const brainChipTxt = document.getElementById("brainChipText");
    const connectBtn   = document.getElementById("connectBtn");
    const startBtn     = document.getElementById("startBtn");
    const muteBtn      = document.getElementById("muteBtn");
    const askBtn       = document.getElementById("askBtn");
    const questionInput= document.getElementById("questionInput");
    const logEl        = document.getElementById("coach-log");

    const ctx = canvasEl.getContext("2d");

    // === STATE ==============================================================
    let detector = null;
    let running = false;
    let stream = null;
    let animId = null;
    let voiceMuted = false;
    let lastPoseVisible = false;

    // === UTIL: logging + speech ============================================
    function addLog(kind, text) {
      const div = document.createElement("div");
      div.className = "log-line " + kind;
      div.textContent = text;
      logEl.appendChild(div);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function speak(text) {
      if (voiceMuted) return;
      if (!("speechSynthesis" in window)) return;

      const utter = new SpeechSynthesisUtterance(text);
      utter.rate = 1.0;
      utter.pitch = 1.0;
      window.speechSynthesis.speak(utter);
    }

    // === INIT BRAIN STATUS ==================================================
    (async () => {
      try {
        const res = await fetch(BRAIN_BASE_URL + "/health");
        if (!res.ok) throw new Error("Health check failed");
        const data = await res.json();
        brainStatusEl.textContent =
          `Phase ${data.phase}, model ${data.openai_model || "unknown"}.`;
        brainChipTxt.textContent =
          `Brain: phase ${data.phase} · model ${data.openai_model || "LLM"}`;
      } catch (err) {
        console.error(err);
        brainStatusEl.textContent = "Could not reach brain API.";
        brainStatusEl.classList.add("status-bad");
        brainChipTxt.textContent = "Brain: offline?";
      }
    })();

    // === CAMERA + POSE ======================================================
    async function connectCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 480 }
        });
        videoEl.srcObject = stream;

        await new Promise((resolve) => {
          videoEl.onloadedmetadata = () => resolve();
        });

        canvasEl.width  = videoEl.videoWidth;
        canvasEl.height = videoEl.videoHeight;

        poseStatusEl.textContent = "Camera connected. Loading pose detector…";

        await initDetector();
        poseStatusEl.textContent = "Pose detector ready. Click Start Workout.";
        poseStatusEl.classList.remove("status-bad");
        poseStatusEl.classList.add("status-ok");
        startBtn.disabled = false;
      } catch (err) {
        console.error(err);
        poseStatusEl.textContent = "Could not access camera.";
        poseStatusEl.classList.add("status-bad");
      }
    }

    async function initDetector() {
      console.log("TensorFlow backend:", tf.getBackend());
      await tf.setBackend("webgl");
      await tf.ready();

      const poseDetectionLoaded = typeof poseDetection !== "undefined";
      console.log("poseDetection loaded:", poseDetectionLoaded);
      if (!poseDetectionLoaded) {
        poseStatusEl.textContent = "Pose library not loaded.";
        poseStatusEl.classList.add("status-bad");
        throw new Error("poseDetection global is missing");
      }

      detector = await poseDetection.createDetector(
        poseDetection.SupportedModels.MoveNet,
        {
          modelType: poseDetection.movenet.modelType.SINGLEPOSE_LIGHTNING
        }
      );
    }

    async function runPoseLoop() {
      if (!detector || !running) return;

      try {
        const poses = await detector.estimatePoses(videoEl, {
          maxPoses: 1,
          flipHorizontal: true
        });

        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);

        let visible = false;

        if (poses && poses.length > 0) {
          const pose = poses[0];
          visible = true;

          // draw keypoints
          const keypoints = pose.keypoints || [];
          ctx.fillStyle = "#22c55e";
          ctx.strokeStyle = "rgba(34,197,94,0.7)";
          ctx.lineWidth = 2;

          for (const kp of keypoints) {
            if (kp.score != null && kp.score > 0.4) {
              ctx.beginPath();
              ctx.arc(kp.x, kp.y, 4, 0, Math.PI * 2);
              ctx.fill();
            }
          }
        }

        poseStatusEl.textContent = visible
          ? "Pose detected. Mufasa can see you."
          : "No person detected – step back and center yourself.";

        // only talk when visibility state changes
        if (visible !== lastPoseVisible) {
          lastPoseVisible = visible;
          if (visible) {
            speak("Good. I can see your full body now.");
          } else {
            speak("I lost you. Step back so I can see your full body.");
          }
        }
      } catch (err) {
        console.error("Pose loop error:", err);
        poseStatusEl.textContent = "Error in pose detection loop.";
        poseStatusEl.classList.add("status-bad");
      }

      if (running) {
        animId = requestAnimationFrame(runPoseLoop);
      }
    }

    async function startWorkout() {
      if (!detector) {
        poseStatusEl.textContent = "Pose detector not ready yet.";
        return;
      }

      if (!running) {
        running = true;
        startBtn.textContent = "Stop Workout";
        startBtn.classList.remove("secondary");
        speak("Workout begins in three, two, one.");
        addLog("system", "Workout started.");
        runPoseLoop();
      } else {
        running = false;
        startBtn.textContent = "Start Workout";
        startBtn.classList.add("secondary");
        if (animId) cancelAnimationFrame(animId);
        ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);
        poseStatusEl.textContent = "Workout stopped.";
        addLog("system", "Workout stopped.");
      }
    }

    // === CHAT WITH BRAIN ====================================================
    async function askCoach() {
      const q = questionInput.value.trim();
      if (!q) return;
      questionInput.value = "";

      addLog("you", "You: " + q);
      brainStatusEl.textContent = "Contacting brain…";

      try {
        const res = await fetch(ASK_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question: q })
        });

        if (!res.ok) {
          const text = await res.text();
          console.error("Brain error:", res.status, text);
          brainStatusEl.textContent = "Brain returned an error.";
          brainStatusEl.classList.add("status-bad");
          addLog("system", "Network error talking to brain.");
          return;
        }

        const data = await res.json();
        const answer = data.answer || data.result || JSON.stringify(data);

        addLog("coach", "Mufasa: " + answer);
        brainStatusEl.textContent = "Coach answered.";
        speak(answer);
      } catch (err) {
        console.error(err);
        brainStatusEl.textContent = "Network error talking to brain.";
        brainStatusEl.classList.add("status-bad");
        addLog("system", "Network error talking to brain.");
      }
    }

    // === WIRE UP BUTTONS ====================================================
    connectBtn.onclick = connectCamera;
    startBtn.onclick   = startWorkout;
    askBtn.onclick     = askCoach;

    muteBtn.onclick = () => {
      voiceMuted = !voiceMuted;
      muteBtn.textContent = voiceMuted ? "Unmute voice" : "Mute voice";
    };

    questionInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") askCoach();
    });

    // On load, log whether TF + poseDetection are visible
    window.addEventListener("load", () => {
      console.log("tf loaded:", typeof tf !== "undefined");
      console.log("poseDetection loaded:", typeof poseDetection !== "undefined");
      addLog("system", "Page loaded. Click “Connect Camera” to begin.");
    });
  </script>
</body>
</html>
