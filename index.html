<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mufasa Coach – Live Form + AI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      min-height: 100vh;
      display: flex;
      align-items: stretch;
      justify-content: center;
      padding: 16px;
    }

    .app {
      width: 100%;
      max-width: 1200px;
      display: grid;
      grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
      gap: 16px;
    }

    @media (max-width: 900px) {
      .app {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    .card {
      background: rgba(15, 23, 42, 0.9);
      border-radius: 12px;
      padding: 16px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
    }

    h1 {
      font-size: 1.6rem;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 1.1rem;
      margin-top: 12px;
      margin-bottom: 8px;
    }

    .video-shell {
      position: relative;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      background: #020617;
      aspect-ratio: 16 / 9;
    }

    video, canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .controls {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #f97316;
      color: white;
      font-weight: 600;
    }

    button.secondary {
      background: #0f172a;
      border: 1px solid #334155;
      color: #e5e7eb;
    }

    button:disabled {
      opacity: 0.4;
      cursor: default;
    }

    .metric-row {
      display: flex;
      gap: 10px;
      font-size: 0.9rem;
      margin-top: 6px;
    }
    .metric-label {
      color: #94a3b8;
    }

    textarea {
      width: 100%;
      min-height: 80px;
      border-radius: 8px;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      padding: 8px;
      resize: vertical;
      font-size: 0.9rem;
    }

    .log-box {
      margin-top: 8px;
      padding: 8px;
      border-radius: 8px;
      background: #020617;
      border: 1px solid #1f2937;
      max-height: 260px;
      overflow-y: auto;
      font-size: 0.85rem;
      white-space: pre-wrap;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 0.8rem;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #4b5563;
      background: rgba(15, 23, 42, 0.9);
      color: #e5e7eb;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #22c55e;
    }
  </style>

  <!-- TensorFlow + Pose Detection (browser) -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core@4.22.0/dist/tf-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter@4.22.0/dist/tf-converter.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl@4.22.0/dist/tf-backend-webgl.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/pose-detection@3.4.0/dist/pose-detection.min.js"></script>
</head>
<body>
  <div class="app">
    <!-- LEFT: Camera + live metrics -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <h1>Mufasa Live Coach</h1>
        <div class="pill">
          <span class="dot" id="brainDot"></span>
          <span id="brainStatus">Brain: connected</span>
        </div>
      </div>

      <p style="font-size:0.9rem;color:#9ca3af;margin-top:4px;">
        Turn on your camera, start the workout, and let Mufasa watch your form.
      </p>

      <div class="video-shell" style="margin-top:10px;">
        <video id="video" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
      </div>

      <div class="controls">
        <button id="camBtn">1. Start Camera</button>
        <button id="workoutBtn" class="secondary" disabled>2. Start Workout Loop</button>
        <button id="stopBtn" class="secondary" disabled>Stop</button>
      </div>

      <h2>Live Metrics</h2>
      <div class="metric-row">
        <span class="metric-label">Reps:</span>
        <span id="repsVal">0</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Estimated depth:</span>
        <span id="depthVal">–</span>
      </div>
      <div class="metric-row">
        <span class="metric-label">Detector:</span>
        <span id="detectorVal">loading…</span>
      </div>
    </div>

    <!-- RIGHT: Chat with Mufasa -->
    <div class="card">
      <h2>Ask Mufasa Anything</h2>
      <p style="font-size:0.9rem;color:#9ca3af;margin-bottom:6px;">
        Example: “Give me a 3-exercise leg workout I can do at home with no equipment.”
      </p>

      <textarea id="coachInput" placeholder="Type your question here…"></textarea>

      <div class="controls" style="margin-top:8px;">
        <button id="askBtn">Ask Coach</button>
      </div>

      <h2>Coach Response</h2>
      <div class="log-box" id="coachLog">Waiting for your first question…</div>

      <h2 style="margin-top:12px;">System Log</h2>
      <div class="log-box" id="sysLog"></div>
    </div>
  </div>

  <script>
    const API_URL = "https://mufasabrain.onrender.com";

    const videoEl    = document.getElementById("video");
    const canvasEl   = document.getElementById("overlay");
    const ctx        = canvasEl.getContext("2d");
    const repsVal    = document.getElementById("repsVal");
    const depthVal   = document.getElementById("depthVal");
    const detectorVal= document.getElementById("detectorVal");
    const coachInput = document.getElementById("coachInput");
    const coachLog   = document.getElementById("coachLog");
    const sysLog     = document.getElementById("sysLog");
    const camBtn     = document.getElementById("camBtn");
    const workoutBtn = document.getElementById("workoutBtn");
    const stopBtn    = document.getElementById("stopBtn");

    let detector = null;
    let running  = false;
    let reps     = 0;
    let lastDepth = 0;

    function logSys(msg) {
      const ts = new Date().toLocaleTimeString();
      sysLog.textContent = `[${ts}] ${msg}\n` + sysLog.textContent;
    }

    // --- Camera setup -------------------------------------------------------
    async function startCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 360 },
          audio: false
        });
        videoEl.srcObject = stream;

        videoEl.onloadedmetadata = () => {
          videoEl.play();
          canvasEl.width  = videoEl.videoWidth;
          canvasEl.height = videoEl.videoHeight;
        };

        camBtn.disabled = true;
        workoutBtn.disabled = false;
        logSys("Camera started.");
      } catch (err) {
        console.error(err);
        alert("Could not access camera. Check permissions.");
        logSys("Camera error: " + err);
      }
    }

    // --- Detector setup -----------------------------------------------------
    async function initDetector() {
      try {
        await tf.setBackend("webgl");
        await tf.ready();
        detector = await posedetection.createDetector(
          posedetection.SupportedModels.MoveNet,
          { modelType: posedetection.movenet.modelType.SINGLEPOSE_LIGHTNING }
        );
        detectorVal.textContent = "MoveNet (single pose)";
        logSys("Pose detector ready.");
      } catch (err) {
        detectorVal.textContent = "failed to load";
        logSys("Detector error: " + err);
        console.error(err);
      }
    }

    // --- Simple pose loop (demo) -------------------------------------------
    async function poseLoop() {
      if (!running || !detector) return;

      const poses = await detector.estimatePoses(videoEl, {flipHorizontal: true});

      ctx.clearRect(0, 0, canvasEl.width, canvasEl.height);

      if (poses.length > 0) {
        const kp = poses[0].keypoints;
        // very rough “depth” estimate using average y of hips and knees
        const leftHip  = kp.find(k => k.name === "left_hip");
        const rightHip = kp.find(k => k.name === "right_hip");
        const leftKnee = kp.find(k => k.name === "left_knee");
        const rightKnee= kp.find(k => k.name === "right_knee");

        if (leftHip && rightHip && leftKnee && rightKnee) {
          const hipY   = (leftHip.y + rightHip.y) / 2;
          const kneeY  = (leftKnee.y + rightKnee.y) / 2;
          const depth  = kneeY - hipY; // bigger = deeper squat (very rough)
          depthVal.textContent = depth.toFixed(1);
          // silly demo rep counter: count rep when depth crosses threshold
          const downThreshold = 40;
          if (depth > downThreshold && lastDepth <= downThreshold) {
            reps += 1;
            repsVal.textContent = reps;
          }
          lastDepth = depth;
        }

        // draw keypoints
        ctx.fillStyle = "#22c55e";
        kp.forEach(p => {
          if (p.score > 0.4) {
            ctx.beginPath();
            ctx.arc(p.x, p.y, 4, 0, Math.PI * 2);
            ctx.fill();
          }
        });
      }

      requestAnimationFrame(poseLoop);
    }

    async function startWorkout() {
      if (!detector) {
        await initDetector();
      }
      running = true;
      workoutBtn.disabled = true;
      stopBtn.disabled = false;
      logSys("Workout loop started.");
      requestAnimationFrame(poseLoop);
    }

    function stopAll() {
      running = false;
      stopBtn.disabled = true;
      workoutBtn.disabled = false;
      logSys("Workout loop stopped.");
    }

    // --- Ask coach via /ask -------------------------------------------------
    async function askCoach() {
      const question = coachInput.value.trim();
      if (!question) return;

      coachLog.textContent = "Asking Mufasa…";
      try {
        const resp = await fetch(API_URL + "/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ question })
        });
        if (!resp.ok) {
          const text = await resp.text();
          throw new Error(resp.status + " " + text);
        }
        const data = await resp.json();
        coachLog.textContent = data.answer || JSON.stringify(data, null, 2);
        logSys("Coach replied.");
      } catch (err) {
        console.error(err);
        coachLog.textContent = "Error talking to coach: " + err;
        logSys("Coach error: " + err);
      }
    }

    camBtn.onclick = startCamera;
    workoutBtn.onclick = startWorkout;
    stopBtn.onclick = stopAll;
    document.getElementById("askBtn").onclick = askCoach;

    window.addEventListener("load", () => {
      logSys("Page loaded. Ready when you are.");
    });
  </script>
</body>
</html>
